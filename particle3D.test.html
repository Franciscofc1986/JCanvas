
<!DOCTYPE HTML> 
<meta charset="utf-8" /> 
<style> 
	canvas {display:block; margin: 60px auto; border: 2px solid #ccc}
</style> 
<script src="JCanvas.js"></script> 
<canvas id="canvas" width="600" height="400"></canvas> 
<script> 
	var system = new ParticleSystem(), 
		dt = .01,
		newMousePos = Vector2.zero,
		oldMousePos = Vector2.zero;
 	//system.gravity = new Vector2(0, 10);
	system.effectors.push(new ParticleBlock(0, 0, 600, 400));
	
	var camera = new Camera();
	var randomDirection = function () {
		var theta = Math.random()*2*Math.PI;
		return new Vector2(Math.cos(theta), Math.sin(theta));
	}
	var randomColor = function (c1, c2) {
		var t = Math.random();
		return c1.multiply(t).add(c2.multiply(1-t));
	}
	var toParticle2D = function (particle3D) {
		var x3 = particle3D.position.x,
			y3 = particle3D.position.y,
			z3 = particle3D.position.z;
		var focal = particle3D.camera.focalLength;
		var scale = focal/(focal+z3);
		var x2 = x3*scale;
		var y2 = y3*scale;
		return {x: x2, y: y2}
	}
 
	var isMouseDown = false;
	var stage = new Stage(document.getElementById('canvas'), {
		draw: function () {
			if (isMouseDown) {//console.log(system.$private.particles[0].position)
				for (var i=0; i< system.$private.particles.length; i++) {
					var p = system.$private.particles[i];
					p.position.rotateY((newMousePos.x-oldMousePos)*.01);
					var pos = toParticle2D(p);
					p.position = new Vector3(pos.x, pos.y, p.position.z);
				}
			} else {
			system.emit( /*new Particle({
				position: new Vector2(300, 200),
				velocity: randomDirection().multiply(100),
				life: 2,
				color: randomColor(Color.red, Color.yellow),
				size: 5
			})*/
				
					new Particle3D({
						position: new Vector3(300, 200, 0),
						camera : camera,
						velocity: randomDirection().multiply(100),
						life: 2,
						color: randomColor(Color.red, Color.yellow),
						size: 5	
					})
				
			 );
			system.simulate(dt);
			
			}
			oldMousePos = newMousePos;
			
			// 每帧让背景黑色半透，可以实现动态模糊的效果
			this.ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
			this.ctx.fillRect(0, 0, 600, 400);
			system.render(this.ctx);
		}
	});
	stage.CONFIG.isClear = false;
	// 加上鼠标控制
	stage.addEventListener('mousemove', function (x, y) {
		newMousePos = new Vector2(x, y);
	});
	stage.addEventListener('mousedown', function (x, y) {
		isMouseDown = true;
	});
	stage.addEventListener('mouseup', function (x, y) {
		isMouseDown = false;
	})
	stage.start();
</script> 
